steps:
- task: AzurePowerShell@5
  displayName: 'Azure PowerShell script: GetKeyVaultAccessPolicies'
  inputs:
    azureSubscription: ${{parameters.azureSubscription}}    
    ScriptPath: ${{ format('{0}/{1}/{2}', '$(Pipeline.Workspace)', parameters.artifactName, 'Key Vault/GetKeyVaultAccessPolicies.ps1' ) }}
    ScriptArguments: ${{ format('{0}{1}', 'kv-', parameters.environment ) }}
    preferredAzurePowerShellVersion: LatestVersion

- task: AzureResourceGroupDeployment@2
  displayName: 'Azure Deployment: Deploy ARM templates'
  inputs:
    azureSubscription: ${{parameters.azureSubscription}}
    action: Create Or Update Resource Group
    resourceGroupName: ${{parameters.resourceGroup}}
    location: ${{parameters.location}}
    templateLocation: Linked artifact
    csmFile: ${{ format('{0}/{1}/{2}', '$(Pipeline.Workspace)', parameters.artifactName, parameters.masterTemplate ) }} 
    csmParametersFile: ${{ format('{0}/{1}/{2}', '$(Pipeline.Workspace)', parameters.artifactName, parameters.parametersFile ) }}
    overrideParameters: '        
        -accessPoliciesKeyVault $(Infra.KeyVault.AccessPolicies)        
    '
    #'Correct syntax highlighting Visual Studio
    deploymentMode: Incremental
