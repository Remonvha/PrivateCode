steps:
- task: AzureFileCopy@3
  displayName: 'Copy Files'
  inputs:
    SourcePath: $(Pipeline.Workspace)/${{parameters.artifactName}}
    azureSubscription: ${{parameters.azureSubscription}}
    Destination: AzureBlob
    storage: ${{parameters.storageAccount.name}}
    ContainerName: ${{parameters.storageAccount.containerName}}
    BlobPrefix:  ${{parameters.storageAccount.blobPrefix}}
    outputStorageUri: storageAccountURI
    outputStorageContainerSasToken: storageAccountSASToken
    sasTokenTimeOutInMinutes: 60

- task: AzurePowerShell@5
  displayName: 'Azure PowerShell script: GetKeyVaultAccessPolicies'
  inputs:
    azureSubscription: ${{parameters.azureSubscription}}    
    ScriptPath: ${{ format('{0}/{1}/{2}', '$(Pipeline.Workspace)', parameters.artifactName, 'key-vault/scripts/GetKeyVaultAccessPolicies.ps1' ) }}
    ScriptArguments: ${{ format('{0}{1}', parameters.keyVault, parameters.environment ) }}
    preferredAzurePowerShellVersion: LatestVersion
    
#Azure Resource Group Deployment task : https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/deploy/azure-resource-group-deployment?view=azure-devops
- task: AzureResourceGroupDeployment@2
  displayName: 'Deploy ARM templates'
  inputs:
    azureSubscription: ${{parameters.azureSubscription}}
    action: Create Or Update Resource Group
    resourceGroupName: ${{parameters.resourceGroup}}
    location: ${{parameters.location}}
    templateLocation: Linked artifact
    csmFile: ${{parameters.masterTemplate}}
    csmParametersFile: ${{parameters.parametersFile}}
    overrideParameters: '
    -storageAccountCICD {
        "url": "$(storageAccountURI)${{parameters.storageAccount.blobPrefix}}",
        "sasToken": "$(storageAccountSASToken)"        
    }
    -accessPoliciesKeyVault $(Infra.KeyVault.AccessPolicies)
    ' #'Correct syntax highlighting Visual Studio
    deploymentMode: 'Incremental'
