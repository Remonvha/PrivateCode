# CI pipeline will be started on every branch
#Comment Code Block Ctrl+K+C / Ctrl+K+U
#Indent ctrl + [  or ctrl + ]


trigger:
  batch: true
  branches:
    include:
    - development
    - master
  paths:
    include:
    - '{path-to-solution}' #current: blueprints/*
    exclude:
    - README.md

variables:
  location: westeurope
  version.MajorMinor: '1' # Manually adjust the version number as needed for semantic versioning. Revision is auto-incremented.
  version.Revision: $[counter(variables['version.MajorMinor'], 0)]
  versionNumber: 'v$(version.MajorMinor).$(version.Revision)'
  blueprintScriptPath: 'azure-blueprint/pipelines/steps/blueprint/'
  blueprintYamlPath: 'azure-blueprint/blueprint' 

# Use build definition name for build/release numbers
name: $(BuildDefinitionName).$(Year:yy)$(DayOfYear)$(rev:.r)

# Call the build process template
stages:
- stage: Build
  jobs:
  - template: 'build-stage.yml'
    parameters:
      artifact:
        blueprintScript:
          directory: '$(blueprintScriptPath)'
          name: 'blueprint-script'
        blueprint:
          directory: '$(blueprintYamlPath)'
          name: 'blueprint'
      azureSubscription: '{service-connection-name}'
      azPipelineTemplateStepPath: './steps'
      environment: build
      pool:
        name: 'Azure pipelines'
        vmImage: windows-2019
      location: $(location)
      blueprint:
        folder: '$(blueprintYamlPath)'
        managementGroupId: '{management-group-id}'
        name: '{blueprint-name}'
        powershellPath : '$(blueprintScriptPath)'
        tenantId: '{tenant-id}'
        VersionId: $(versionNumber)
      spDisplayName: 'azuredevops-pipeline-build-blueprint-sp'
  
- stage: Development
  dependsOn: Build
  condition: succeeded()
  jobs:
  - template: 'release-stage.yml'
    parameters:
      azureSubscription: '{service-connection-name}'
      azPipelineTemplateStepPath: './steps'
      devOpsEnvironment: '{devOps-environment-name}'
      environment: dev
      pool:
        name: 'Azure pipelines'
        vmImage: windows-2019
      location: $(location)
      blueprint:
        folder: '$(blueprintYamlPath)'
        managementGroupId: '{managementgroup-id}'
        name: '{blueprint-name}'
        powershellPath: '$(Pipeline.Workspace)/blueprint-script/'
        tenantId: ''
        subscriptionId: ''
        VersionId: $(versionNumber)
        parametersPath: '$(Pipeline.Workspace)/blueprint/blueprintAssignment-dev.json'
      spDisplayName: 'azuredevops-pipeline-release-blueprint-sp'
